---
# Playbook to print inventory and group variables
#
# Defined variables in survey:
#
# target_version - firmware version to be upgraded to
# upgrade_filename - filename of the firmware 
#
- name: Print inventory and group variables in AWX
  hosts: all
  gather_facts: false
  tasks:

    # Task 1: Gather necessary facts
    - name: Gather facts from Cisco devices
      cisco.ios.ios_facts:
        gather_subset:
          - hardware
      register: facts

    - name: Display running version
      debug:
        msg: "Current version is {{ facts.ansible_facts.ansible_net_version }}"

    - name: Display target version captured from survey
      debug:
        msg: "Target version is {{ target_version }}"

    - name: Stop following tasks if the device does not need to upgrade
      fail:
        msg: "Device is already running the latest {{ target_version }} version. Upgrade procedure stops."
      when:
        - facts.ansible_facts.ansible_net_version == target_version

    - name: Assign device_storage variable
      set_fact:
        device_type: "{{ ('router' if 'bootflash:' in facts.ansible_facts.ansible_net_image else 'switch') | trim }}"
      
    - name: Run "show version" to check if the device is in INSTALL mode
      cisco.ios.ios_command:
        commands:
          - show version
      register: version_output
      when: device_type == 'switch'

    - name: Parse "show version" output for INSTALL mode
      set_fact:
        in_install_mode: "{{ 'INSTALL' in version_output.stdout[0] }}"
      when: device_type == 'switch'

    - name: Run "show run | inc boot" to check if the device is in INSTALL mode
      cisco.ios.ios_command:
        commands:
          - show version
      register: version_output
      when: device_type == 'router'

    - name: Parse "show run | inc boot" output for INSTALL mode
      set_fact:
        in_install_mode: "{{ 'packages.conf' in version_output.stdout[0] }}"
      when: device_type == 'router'

    - name: Display whether the device is in INSTALL mode
      debug:
        msg: "The device is in INSTALL mode: {{ in_install_mode }}"

    - name: Assign device_storage variable
      set_fact:
        device_storage: "{{ facts.ansible_facts.ansible_net_filesystems[0] }}"

    - name: Assign the device path and file for checking
      set_fact:
        device_file: "{{ device_storage }}{{ upgrade_filename }}"

    - block:
        # Task 1: Check if the file exists
        - name: Check if the file exists on the device
          cisco.ios.ios_command:
            commands: "dir {{ device_file }}"
          register: file_check
          ignore_errors: no  # Don't ignore errors here; use rescue to catch errors.

        # Task 2: Parse the file check result
        - name: Parse the file check result
          set_fact:
            file_exists: "{{ 'stdout' in file_check and 'No such file' not in file_check.stdout[0] }}"

      rescue:
        # Error handling: when `dir` command fails (e.g., command not found)
        - name: Print error message
          debug:
            msg: "Error: File does not exist on host {{ inventory_hostname }}. Stopping upgrade procedure."

        # Stop all remaining tasks for this host
        - name: Fail the task and stop further tasks for this host
          fail:
            msg: "Stopping further tasks on host {{ inventory_hostname }} due to upgrade file not exist."

    # Print inventory hostname
    - name: Print inventory hostname
      debug:
        msg: "Inventory Hostname: {{ inventory_hostname }}"

    # Print ansible_host variable (usually set in inventory)
    - name: Print ansible_host (IP or hostname of the target)
      debug:
        msg: "Ansible Host: {{ ansible_host }}"

    # Print another group or inventory variable (example: device_storage)
    - name: Print group variable 'device_storage'
      debug:
        msg: "Group Variable - device_storage: {{ device_storage }}"

    # Print all variables available for the host
    - name: Print all host variables
      debug:
        var: hostvars[inventory_hostname]

